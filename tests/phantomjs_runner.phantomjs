function waitFor(testFx, onReady, timeOutMillis) {
    var maxtimeOutMillis = timeOutMillis ? timeOutMillis : 30000, //< Default Max Timout is 30s
        start = new Date().getTime(),
        condition = false,
        interval = setInterval(function() {
            if ( (new Date().getTime() - start < maxtimeOutMillis) && !condition ) {
                // If not time-out yet and condition not yet fulfilled
                condition = (typeof(testFx) === "string" ? eval(testFx) : testFx()); //< defensive code
            } else {
                if(!condition) {
                    // If condition still not fulfilled (timeout but condition is 'false')
                    console.log("'waitFor()' timeout ("+(new Date().getTime() - start)+"ms elapsed)");
                    phantom.exit(-1);
                } else {
                    // Condition fulfilled (timeout and/or condition is 'true')
                    typeof(onReady) === "string" ? eval(onReady) : onReady(); //< Do what it's supposed to do once the condition is fulfilled
                    clearInterval(interval); //< Stop this interval
                }
            }
        }, 250); //< repeat check every 250ms
};

var env = require('system').env;
var args = require('system').args;

var travis=env['TRAVIS_JOB_ID']?env['TRAVIS_JOB_ID']:false,
    verbose=env['VERBOSE']?env['VERBOSE']:false,
    port=env['PORT']?env['PORT']:4020,
    host=env['IP']?env['IP']:"127.0.0.1",
    filter=(args.length === 2 ? new RegExp(args[1]) : false);

if(!travis && verbose) {
  page.onError = function(err, stack) {
    console.log("CONSOLE ERROR: "+err);
  };

  page.onConsoleMessage = function(msg, lineNum, sourceId) {
    console.log('CONSOLE: ' + msg);
  };
}

var urls=[
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/layout.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/sendEvent.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/firstResponder.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/keyPane.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/child_view.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/pane/append_remove.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/main_pane.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/didAppendToDocument.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/replaceChild.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/enabled_states_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/render_delegate_support.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/render.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/destroy.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/build_children.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/init.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/convertFrames.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/removeChild.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/static_layout.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/view_states_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/layer.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/insertBefore.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/findLayerInParentLayer.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/createLayer.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/childViewLayout_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/theme.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/touch.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/convertLayouts.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/class_name_bindings_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/attribute_bindings_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/animation.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/layoutChildViews.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/border_frame_test.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/layoutStyle.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/clippingFrame.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/view.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/createChildViews.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/layoutDidChange.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/viewDidResize.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/updateLayer.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/keyboard.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/destroyLayer.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/isVisibleInWindow.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/build.html'},
    {url:'sproutcore/core_foundation/en/current/tests/views/view/isVisible.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/sparse_array.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/utils/rect.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/utils/offset.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/utils/normalizeURL.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/core_query/within.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/browser.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/builder.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/event.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/theme.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/join.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/push_text.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/init.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/element.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/helpers_basic.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/update.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/helpers_style.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/tag.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/begin.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/helpers_className.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/escape_html.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/helpers_attr.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/end.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/render_context/get.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/timer/invokeLater.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/timer/isPaused.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/timer/performAction.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/timer/schedule.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/timer/invalidate.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/platform.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/root_responder/makeMenuPane.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/root_responder/targetForAction.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/root_responder/makeKeyPane.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/root_responder/makeMainPane.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/root_responder/root_responder.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/selection_set/indexSetForSource.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/selection_set/isEqual.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/selection_set/copy.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/selection_set/remove.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/selection_set/add.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/ready/done.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/color.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/cursor.html'},
    {url:'sproutcore/core_foundation/en/current/tests/system/locale.html'},
    {url:'sproutcore/core_foundation/en/current/tests/mixins/string.html'},
    {url:'sproutcore/core_foundation/en/current/tests/mixins/action_support.html'},
    {url:'sproutcore/core_foundation/en/current/tests/mixins/responder_context.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/array/single_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/array/selection_support.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/array/null_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/array/array_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/array/enum_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/object/single_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/object/empty_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/object/content_destroyed.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/object/single_enumerable_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/controllers/object/multiple_case.html'},
    {url:'sproutcore/core_foundation/en/current/tests/ext/object_test.html'},
    {url:'sproutcore/ajax/en/current/tests/system/request.html'},
    {url:'sproutcore/media/en/current/tests/media_capabilities.html'},
    {url:'sproutcore/designer/en/current/tests/designers/view_designer.html'},
    {url:'sproutcore/designer/en/current/tests/coders/page.html'},
    {url:'sproutcore/formatters/en/current/tests/date_formatter.html'},
    {url:'sproutcore/foundation/en/current/tests/debug/control_test_pane/methods.html'},
    {url:'sproutcore/foundation/en/current/tests/debug/control_test_pane/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/views/label/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/views/text_field/methods.html'},
    {url:'sproutcore/foundation/en/current/tests/views/text_field/nextValidKeyView.html'},
    {url:'sproutcore/foundation/en/current/tests/views/text_field/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/views/container/methods.html'},
    {url:'sproutcore/foundation/en/current/tests/views/container/transition_test.html'},
    {url:'sproutcore/foundation/en/current/tests/views/container/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/views/image/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/delegates/inline_text_field/inline_text_field.html'},
    {url:'sproutcore/foundation/en/current/tests/system/utils/pointInElement.html'},
    {url:'sproutcore/foundation/en/current/tests/system/utils/range.html'},
    {url:'sproutcore/foundation/en/current/tests/system/image_queue.html'},
    {url:'sproutcore/foundation/en/current/tests/system/core_query/setClass.html'},
    {url:'sproutcore/foundation/en/current/tests/system/string.html'},
    {url:'sproutcore/foundation/en/current/tests/system/app_cache_test.html'},
    {url:'sproutcore/foundation/en/current/tests/system/math.html'},
    {url:'sproutcore/foundation/en/current/tests/system/cookie.html'},
    {url:'sproutcore/foundation/en/current/tests/system/task_queue.html'},
    {url:'sproutcore/foundation/en/current/tests/system/user_defaults.html'},
    {url:'sproutcore/foundation/en/current/tests/integration/creating_views.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editable/commitEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editable/discardEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editable/beginEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/flowed_layout/tests.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editor/commitEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editor/discardEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_editor/beginEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/staticLayout.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/control/displayProperties.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/validatable/ui.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/content_value_support/content.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_text_field/api.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/inline_text_field/beginEditing.html'},
    {url:'sproutcore/foundation/en/current/tests/mixins/content_display.html'},
    {url:'sproutcore/foundation/en/current/tests/controllers/tree/selection_support.html'},
    {url:'sproutcore/foundation/en/current/tests/controllers/tree/outline_case.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/validator.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/date.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/number.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/not_empty.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/credit_card.html'},
    {url:'sproutcore/foundation/en/current/tests/validators/password.html'},
    {url:'sproutcore/foundation/en/current/tests/render_delegates/render_delegate.html'},
    {url:'sproutcore/foundation/en/current/tests/private/tree_item_observer/flat_case.html'},
    {url:'sproutcore/foundation/en/current/tests/private/tree_item_observer/group_case.html'},
    {url:'sproutcore/foundation/en/current/tests/private/tree_item_observer/outline_case.html'},
    {url:'sproutcore/runtime/en/current/tests/system/run_loop.html'},
    {url:'sproutcore/runtime/en/current/tests/system/string.html'},
    {url:'sproutcore/runtime/en/current/tests/system/range_observer/create.html'},
    {url:'sproutcore/runtime/en/current/tests/system/range_observer/destroy.html'},
    {url:'sproutcore/runtime/en/current/tests/system/range_observer/objectPropertyDidChange.html'},
    {url:'sproutcore/runtime/en/current/tests/system/range_observer/rangeDidChange.html'},
    {url:'sproutcore/runtime/en/current/tests/system/range_observer/update.html'},
    {url:'sproutcore/runtime/en/current/tests/system/observer_set.html'},
    {url:'sproutcore/runtime/en/current/tests/system/json.html'},
    {url:'sproutcore/runtime/en/current/tests/system/logger.html'},
    {url:'sproutcore/runtime/en/current/tests/system/error.html'},
    {url:'sproutcore/runtime/en/current/tests/system/set.html'},
    {url:'sproutcore/runtime/en/current/tests/system/binding.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/create.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/removeEach.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/clone.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/max.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/addEach.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/rangeStartForIndex.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/contains.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/without.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/indexAfter.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/intersects.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/infinite.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/min.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/indexBefore.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/remove.html'},
    {url:'sproutcore/runtime/en/current/tests/system/index_set/add.html'},
    {url:'sproutcore/runtime/en/current/tests/system/object/bindings.html'},
    {url:'sproutcore/runtime/en/current/tests/system/object/enhance.html'},
    {url:'sproutcore/runtime/en/current/tests/system/object/base.html'},
    {url:'sproutcore/runtime/en/current/tests/system/object/concatenated_properties.html'},
    {url:'sproutcore/runtime/en/current/tests/system/object/mixin.html'},
    {url:'sproutcore/runtime/en/current/tests/core/objectForPropertyPath.html'},
    {url:'sproutcore/runtime/en/current/tests/core/inspect.html'},
    {url:'sproutcore/runtime/en/current/tests/core/keys.html'},
    {url:'sproutcore/runtime/en/current/tests/core/requiredObjectForPropertyPath.html'},
    {url:'sproutcore/runtime/en/current/tests/core/isArray.html'},
    {url:'sproutcore/runtime/en/current/tests/core/clone.html'},
    {url:'sproutcore/runtime/en/current/tests/core/guidFor.html'},
    {url:'sproutcore/runtime/en/current/tests/core/makeArray.html'},
    {url:'sproutcore/runtime/en/current/tests/core/compare.html'},
    {url:'sproutcore/runtime/en/current/tests/core/itemType.html'},
    {url:'sproutcore/runtime/en/current/tests/core/tupleForPropertyPath.html'},
    {url:'sproutcore/runtime/en/current/tests/core/beget.html'},
    {url:'sproutcore/runtime/en/current/tests/core/IsEqual.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/enumerable/enumerable_observers.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/enumerable/enumerable.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/array.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/observable/observable.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/observable/chained.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/observable/propertyChanges.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/observable/observersForKey.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/observable/registerDependentKeys.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/propertyChanges.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/array_observers.html'},
    {url:'sproutcore/runtime/en/current/tests/mixins/comparable.html'},
    {url:'sproutcore/runtime/en/current/tests/private/observer_queue.html'},
    {url:'sproutcore/testing/en/current/tests/stub_method.html'},
    {url:'sproutcore/testing/en/current/tests/spy_on.html'},
    {url:'sproutcore/datastore/en/current/tests/data_sources/cascade.html'},
    {url:'sproutcore/datastore/en/current/tests/data_sources/data_source.html'},
    {url:'sproutcore/datastore/en/current/tests/data_sources/fixtures.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/containsRecordTypes.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/instance_management.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/evaluation_of_records.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/builders.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/contains.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/compare.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/expandedRecordTypes.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/queryWithScope.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/registered_query_extensions.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/copy.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/registered_comparisons.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/record_type_is.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/evaluation.html'},
    {url:'sproutcore/datastore/en/current/tests/system/query/parse.html'},
    {url:'sproutcore/datastore/en/current/tests/system/many_array/core_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/core_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/removeDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/init.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/readDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/find.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/createRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/retrieveRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/commitRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/destroyRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/commitChangesFromNestedStore.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/error_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/unloadRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/writeDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/dataHashDidChange.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/loadRecords.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/unloadRecords.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/pushChanges.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/cancelRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/connectDataSource.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/readEditableDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/pushRelationships.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/loadRecord.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/dataSourceCallbacks.html'},
    {url:'sproutcore/datastore/en/current/tests/system/store/recordDidChange.html'},
    {url:'sproutcore/datastore/en/current/tests/system/record_array/core_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/record_array/flush.html'},
    {url:'sproutcore/datastore/en/current/tests/system/record_array/error_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/record_array/array_observers.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/core_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/removeDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/readDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/discardChanges.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/commitChangesFromNestedStore.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/writeDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/chain.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/dataHashDidChange.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/readEditableDataHash.html'},
    {url:'sproutcore/datastore/en/current/tests/system/nested_store/commitChanges.html'},
    {url:'sproutcore/datastore/en/current/tests/integration/mail_model.html'},
    {url:'sproutcore/datastore/en/current/tests/integration/many_array.html'},
    {url:'sproutcore/datastore/en/current/tests/integration/contact_model.html'},
    {url:'sproutcore/datastore/en/current/tests/integration/cyclical_relationship.html'},
    {url:'sproutcore/datastore/en/current/tests/integration/test_runner_model.html'},
    {url:'sproutcore/datastore/en/current/tests/models/single_attribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/many_attribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/core_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/readAttribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/destroy.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/unknownProperty.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/error_methods.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/normalize.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/writeAttribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/refresh.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record/storeDidChangeProperties.html'},
    {url:'sproutcore/datastore/en/current/tests/models/datetime_recordattribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/record_attribute.html'},
    {url:'sproutcore/datastore/en/current/tests/models/nested_records/data_store.html'},
    {url:'sproutcore/datastore/en/current/tests/models/nested_records/nested_record_array.html'},
    {url:'sproutcore/datastore/en/current/tests/models/nested_records/nested_record_array_complex.html'},
    {url:'sproutcore/datastore/en/current/tests/models/nested_records/nested_record.html'},
    {url:'sproutcore/datastore/en/current/tests/models/nested_records/nested_record_complex.html'},
    {url:'sproutcore/statechart/en/current/tests/debug/sequence_matcher.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/advanced/without_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/basic/without_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/basic/with_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/responder/pane.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/responder/root_responder.html'},
    {url:'sproutcore/statechart/en/current/tests/event_handling/responder/responder_chain.html'},
    {url:'sproutcore/statechart/en/current/tests/state/plugin/nesting.html'},
    {url:'sproutcore/statechart/en/current/tests/state/plugin/mixin.html'},
    {url:'sproutcore/statechart/en/current/tests/state/is_current_state.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/try_to_handle_event.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/get_substate.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/route_triggered.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/get_state.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/add_substate.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/find_first_relative_current_state/with_concurrent.html'},
    {url:'sproutcore/statechart/en/current/tests/state/methods/find_first_relative_current_state/without_concurrent.html'},
    {url:'sproutcore/statechart/en/current/tests/state/state_observes.html'},
    {url:'sproutcore/statechart/en/current/tests/state/initial_substate.html'},
    {url:'sproutcore/statechart/en/current/tests/system/state_route_handler_context/methods/retry.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/standard/without_concurrent_states/core.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/standard/without_concurrent_states/context.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/standard/with_concurrent_states/advanced.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/standard/with_concurrent_states/intermediate.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/standard/with_concurrent_states/basic.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/transient/without_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/history_state/initial_substate/without_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/history_state/initial_substate/core.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/history_state/standard/without_concurrent_states/core.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/history_state/standard/without_concurrent_states/context.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/history_state/standard/with_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/async/without_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/async/core.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/async/with_concurrent_states.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/routing/without_concurrent_states/basic.html'},
    {url:'sproutcore/statechart/en/current/tests/state_transitioning/routing/with_concurrent_states/basic.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/create/assigned_root_state.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/create/unassigned_root_state.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/destroy.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/methods/get_state.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/methods/invoke_state_method.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/owner.html'},
    {url:'sproutcore/statechart/en/current/tests/statechart/respond_to_event.html'},
    {url:'sproutcore/statechart/en/current/tests/private/state_path_matcher.html'},/*
    {url:'sproutcore/experimental/en/current/tests/frameworks/select_view/views/popup_button/menu_setup.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/views/popup_button/show_menu.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/views/select/selected_item.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/views/select/menu_width.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/mixins/select_view_menu/check_selected.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/mixins/select_view_menu/bindings.html'},
    {url:'sproutcore/experimental/frameworks/select_view/en/current/tests/ext/menu_resizing.html'},
    {url:'sproutcore/experimental/frameworks/forms/en/current/tests/views/form_row.html'},
    {url:'sproutcore/experimental/frameworks/forms/en/current/tests/views/form.html'},
    {url:'sproutcore/experimental/frameworks/forms/en/current/tests/mixins/edit_mode.html'},
    {url:'sproutcore/experimental/frameworks/forms/en/current/tests/mixins/emptiness.html'},
    {url:'sproutcore/experimental/frameworks/polymorphism/en/current/tests/models/polymorphism/single.html'},
    {url:'sproutcore/experimental/frameworks/polymorphism/en/current/tests/models/polymorphism/simple.html'},
    {url:'sproutcore/experimental/frameworks/polymorphism/en/current/tests/models/polymorphism/many.html'},
    {url:'sproutcore/experimental/frameworks/menu/en/current/tests/menu/scroll.html'},
    {url:'sproutcore/experimental/frameworks/scroll_view/en/current/tests/scroll/methods.html'},
    {url:'sproutcore/experimental/frameworks/scroll_view/en/current/tests/scroll/ui.html'},
    {url:'sproutcore/experimental/frameworks/scroll_view/en/current/tests/scroll/integration.html'},*/
    {url:'sproutcore/desktop/en/current/tests/panes/select_button/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/select_button/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/picker/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/picker/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/menu/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/menu/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/sheet/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/sheet/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/pane_page.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/palette/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/palette/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/panel/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/panel/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/alert/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/panes/alert/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/date_field/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/date_field/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/well/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/stacked/ui_comments.html'},
    {url:'sproutcore/desktop/en/current/tests/views/slider/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/slider/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/source_list/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/source_list/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/checkbox/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/checkbox/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/separator.html'},
    {url:'sproutcore/desktop/en/current/tests/views/toolbar/method.html'},
    {url:'sproutcore/desktop/en/current/tests/views/toolbar/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/web/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/web/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/segmented/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/segmented/observers.html'},
    {url:'sproutcore/desktop/en/current/tests/views/segmented/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/grid/drag_and_drop.html'},
    {url:'sproutcore/desktop/en/current/tests/views/grid/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/grid/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/static_content.html'},
    {url:'sproutcore/desktop/en/current/tests/views/select_field/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/select_field/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/radio/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/radio/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/scroller.html'},
    {url:'sproutcore/desktop/en/current/tests/views/button/content.html'},
    {url:'sproutcore/desktop/en/current/tests/views/button/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/button/keyEquivalents.html'},
    {url:'sproutcore/desktop/en/current/tests/views/button/displayProperties.html'},
    {url:'sproutcore/desktop/en/current/tests/views/button/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/drag_and_drop.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/rowDelegate.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/render.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/ui_simple.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/rowHeightForContentIndex.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/ui_row_heights.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/ui_alternatingrows.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/ui_outline.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list/rowOffsetForContentIndex.html'},
    {url:'sproutcore/desktop/en/current/tests/views/scroll/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/scroll/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/scroll/integration.html'},
    {url:'sproutcore/desktop/en/current/tests/views/menu_item/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/menu_item/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/children.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/split_thumb.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/dividers.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/split/split_child.html'},
    {url:'sproutcore/desktop/en/current/tests/views/image_button/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/content.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/selectNextItem.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/deleteSelection.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/ui_diagram.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/length.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/displayProperties.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/mouse.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/reload.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/layerIdFor.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/itemViewForContentIndex.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/deselect.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/selection.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/nowShowing.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/select.html'},
    {url:'sproutcore/desktop/en/current/tests/views/collection/selectPreviousItem.html'},
    {url:'sproutcore/desktop/en/current/tests/views/select/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/select/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/tab/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/tab/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/progress/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/progress/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/views/list_item.html'},
    {url:'sproutcore/desktop/en/current/tests/views/disclosure/methods.html'},
    {url:'sproutcore/desktop/en/current/tests/views/disclosure/ui.html'},
    {url:'sproutcore/desktop/en/current/tests/integration/dialog.html'},
    {url:'sproutcore/bootstrap/en/current/tests/system/browser.html'},
    {url:'sproutcore/template_view/en/current/tests/panes/template.html'},
    {url:'sproutcore/template_view/en/current/tests/views/template/collection.html'},
    {url:'sproutcore/template_view/en/current/tests/views/template/handlebars.html'},
    {url:'sproutcore/template_view/en/current/tests/views/template/core.html'},
    {url:'sproutcore/template_view/en/current/tests/mixins/template_helpers/text_field_support.html'},
    {url:'sproutcore/template_view/en/current/tests/mixins/template_helpers/checkbox_support.html'},
    {url:'sproutcore/template_view/en/current/tests/controls/button.html'},
    {url:'sproutcore/routing/en/current/tests/system/routes.html'}
];

var SKIPPED=-2;
var FAILED_TO_LOAD=-1;
var TEST_PASSED=0;
var TEST_FAILED=1;
var TEST_ERROR=2;


var run=0;
var skipped=0;
var outcome=0;
var failed=0;
var webpage = require('webpage');

function logResult(r,i) {
    // output coloring
    var red, blue, reset;
    red   = '\033[31m';
    green  = '\033[32m';
    reset = '\033[0m';
    console.log( "[" + (i+1) +"/"+ urls.length + "] " + (r.status === TEST_PASSED ? green : red ) + r.url + reset + " (" + r.status + "): " + r.resultText);
}

function runTest(idx, cb) {
    if(idx==urls.length) {
        cb.apply();
        return;
    }
    var url=urls[idx].url;
    
    // check if the user provided a filter, run only tests that match it
    //
    if (!filter || url.match(filter)) {
        run++;
        var page = webpage.create();
        page.viewportSize = { width: 1024, height: 768 };
        // Chrome/Linux
        //page.settings.userAgent = "Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.71 Safari/537.36";
        page.open('http://'+host+':'+port+'/'+url, function (status) {
            // detect and skip multiple callbacks calls
            if(urls[idx].open) return;
            
            // mark page as opened
            urls[idx].open = true;
    
            // Check for page load success
            if (status !== "success") {
                urls[idx].open=false;
                urls[idx].resultText="unable to access page: "+status;
                urls[idx].status=FAILED_TO_LOAD; outcome=1; failed++;
                logResult(urls[idx], idx);
                page.close();
                runTest(++idx,cb);
            } else {
                waitFor(function() {
                    // Check in the page if a specific element is now visible
                    return urls[idx].open && page.evaluate(function() {
                        var statusText = $("span.status").text();
                        return statusText.indexOf("Running â€“ Completed") == -1 && statusText.indexOf("Running...") == -1;
                    });
                }, function() {
                    // sometimes the callback could be called more than once,
                    // in that case check that we have not run through the test already
                    if(urls[idx].open) {
                        // close the test
                        urls[idx].open=false;
                        
                        // checking outcome
                        var resultText = page.evaluate(function() {
                            return $("span.status").text();
                        });
                        urls[idx].resultText=resultText;
                        if(resultText.indexOf("failed")!=-1) {
                          urls[idx].status=TEST_FAILED; outcome=1; failed++;
                        } else if(resultText.indexOf("error")!=-1) {
                          urls[idx].status=TEST_ERROR; outcome=1; failed++;
                        } else {
                          urls[idx].status=TEST_PASSED;
                        }
                        logResult(urls[idx], idx);
                        page.close();
                        runTest(++idx,cb);
                    }
                });        
            }
        });
    } else {
        // skip this test and try the next
        skipped++;
        urls[idx].status=SKIPPED;
        runTest(++idx,cb);
    }
}

runTest(0, function() {
    console.log("\n"+run + " out of " + urls.length + " tests run, " + failed + " failures" + (failed>0 ? ":\n" : ".\n") );
    
    for(var i=0,l=urls.length;i<l;i++) {
        if( urls[i].status!==SKIPPED && urls[i].status!==TEST_PASSED ) {
            logResult(urls[i], i);
        }
    }
    
    phantom.exit(outcome);
});

